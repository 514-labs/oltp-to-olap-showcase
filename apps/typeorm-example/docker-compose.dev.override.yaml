# Moose CDC Extension - Docker Compose Override
#
# This file extends the base Moose infrastructure with CDC capabilities.
# It connects to your existing OLTP PostgreSQL database and streams changes.
#
# Prerequisites:
#   1. PostgreSQL must be running: docker compose -f docker-compose.oltp.yaml up -d
#   2. Tables must exist: npm run dev (creates tables)
#   3. CDC must be configured: ./setup.sh setup-cdc
#   4. REDPANDA_LICENSE must be set: export REDPANDA_LICENSE="your_key"
#
# Recommended workflow:
#   ./setup.sh              # Interactive setup (handles all prerequisites)
#   OR
#   make start              # Convenient shortcut
#
# Start manually:
#   docker compose -f docker-compose.oltp.yaml -f docker-compose.dev.override.yaml up -d redpanda-connect

services:
  # CDC Connector - Redpanda Connect with PostgreSQL CDC
  # Streams changes from OLTP PostgreSQL to Redpanda topics
  # Requires: REDPANDA_LICENSE environment variable
  #
  # NOTE: Before starting this service, you must:
  #   1. Start PostgreSQL
  #   2. Create tables (run your app)
  #   3. Setup CDC (run: ./setup.sh setup-cdc)
  #
  redpanda-connect:
    image: docker.redpanda.com/redpandadata/connect:latest
    container_name: redpanda-connect
    volumes:
      - ../redpanda-connect.yaml:/connect.yaml:ro
    command: ["run", "/connect.yaml"]
    ports:
      - "4195:4195" # HTTP API for health checks and metrics
    environment:
      REDPANDA_LICENSE: ${REDPANDA_LICENSE:-}
      POSTGRES_CDC_DSN: "postgres://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@${APP_NAME:-typeorm}-postgres:5432/${POSTGRES_DB:-typeorm_db}?sslmode=disable"
      LOG_LEVEL: "info"
    networks:
      - default
      - shared # Connect to shared network with PostgreSQL
    restart: unless-stopped

networks:
  shared:
    name: ${APP_NAME:-typeorm}-shared-network
    external: true
