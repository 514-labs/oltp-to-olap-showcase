version: "3.8"

services:
  # CDC Setup - Runs once to create publication
  cdc-setup:
    image: postgres:15-alpine
    container_name: sqlalchemy-cdc-setup
    depends_on:
      - redpanda
    command: >
      sh -c "
      echo '‚è≥ Waiting for tables to be created by FastAPI...';
      while ! PGPASSWORD=postgres psql -h sqlalchemy-oltp-postgres -U postgres -d sqlalchemy_db -c \"SELECT 1 FROM information_schema.tables WHERE table_name = 'customers' LIMIT 1\" | grep -q 1; do
        echo '   Tables not ready yet, waiting 5s...';
        sleep 5;
      done;
      echo '‚úÖ Tables created!';
      echo 'üì° Creating CDC publication...';
      PGPASSWORD=postgres psql -h sqlalchemy-oltp-postgres -U postgres -d sqlalchemy_db <<-EOSQL
        DO \$\$
        BEGIN
          IF NOT EXISTS (SELECT 1 FROM pg_publication WHERE pubname = 'redpanda_cdc_publication') THEN
            CREATE PUBLICATION redpanda_cdc_publication FOR ALL TABLES;
            RAISE NOTICE 'Publication created';
          ELSE
            RAISE NOTICE 'Publication already exists';
          END IF;
        END
        \$\$;
      EOSQL
      echo '‚úÖ CDC publication ready!';
      echo 'üéâ CDC Setup Complete!';
      tail -f /dev/null
      "
    networks:
      - default
      - sqlalchemy-oltp-network
    restart: unless-stopped

  # Redpanda Connect - CDC Connector
  redpanda-connect:
    image: docker.redpanda.com/redpandadata/connect:latest
    container_name: sqlalchemy-redpanda-connect
    depends_on:
      - cdc-setup
      - redpanda
    environment:
      REDPANDA_LICENSE: ${REDPANDA_LICENSE}
    volumes:
      - ../redpanda-connect.yaml:/connect.yaml:ro
    command: ["run", "/connect.yaml"]
    ports:
      - "4196:4195"
    networks:
      - default
      - sqlalchemy-oltp-network
    restart: unless-stopped

networks:
  sqlalchemy-oltp-network:
    external: true
