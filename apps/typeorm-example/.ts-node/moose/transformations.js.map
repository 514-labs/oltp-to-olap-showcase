{"version":3,"file":"transformations.js","sourceRoot":"","sources":["../../moose/transformations.ts"],"names":[],"mappings":";;AAAA,6DAAkE;AAClE,6CAAoJ;AAEpJ,kDAAoD;AACpD,SAAS,mBAAmB,CAAI,KAA8B;IAC1D,IAAA,kBAAM,EAAC;QACH,MAAM,EAAE,eAAe;QACvB,OAAO,EAAE,IAAI,CAAC,SAAS,CAAC,KAAK,CAAC;KACjC,CAAC,CAAC;IACH,IAAA,kBAAM,EAAC;QACH,MAAM,EAAE,SAAS;QACjB,OAAO,EAAE,IAAI,CAAC,SAAS,CAAC,KAAK,CAAC,OAAO,CAAC;KACzC,CAAC,CAAC;IACH,MAAM,GAAG,GAAG,QAAQ,CAAC,KAAK,CAAC,QAAQ,CAAC,GAAG,EAAE,EAAE,CAAC,CAAC;IAC7C,IAAI,KAAK,CAAC,QAAQ,CAAC,SAAS,KAAK,QAAQ,EAAE,CAAC;QACxC,OAAO;YACH,GAAG,KAAK,CAAC,OAAO;YAChB,UAAU,EAAE,CAAC;YACb,GAAG,EAAE,GAAG;SACM,CAAC;IACvB,CAAC;IACD,OAAO;QACH,GAAG,KAAK,CAAC,OAAO;QAChB,UAAU,EAAE,CAAC;QACb,GAAG,EAAE,GAAG;KACM,CAAC;AACvB,CAAC;AACD,uCAAsB,CAAC,WAAW,CAAC,CAAC,KAAc,EAAQ,EAAE;IACxD,MAAM,QAAQ,GAAG,KAAoG,CAAC;IACtH,IAAI,gBAAgB,CAAC;IACrB,QAAQ,QAAQ,CAAC,QAAQ,CAAC,KAAK,EAAE,CAAC;QAC9B,KAAK,UAAU;YACX,gBAAgB,GAAG,mBAAmB,CAAmB,QAAkD,CAAC,CAAC;YAC7G,mCAAsB,CAAC,IAAI,CAAC,gBAAgB,CAAC,CAAC;YAC9C,MAAM;QACV,KAAK,WAAW;YACZ,gBAAgB,GAAG,mBAAmB,CAAoB,QAAmD,CAAC,CAAC;YAC/G,oCAAuB,CAAC,IAAI,CAAC,gBAAgB,CAAC,CAAC;YAC/C,MAAM;QACV,KAAK,QAAQ;YACT,gBAAgB,GAAG,mBAAmB,CAAiB,QAAgD,CAAC,CAAC;YACzG,iCAAoB,CAAC,IAAI,CAAC,gBAAgB,CAAC,CAAC;YAC5C,MAAM;QACV,KAAK,aAAa;YACd,gBAAgB,GAAG,mBAAmB,CAAgB,QAA+C,CAAC,CAAC;YACvG,4BAAe,CAAC,IAAI,CAAC,gBAAgB,CAAC,CAAC;YACvC,MAAM;QACV;YACI,MAAM,IAAI,KAAK,CAAC,kBAAkB,QAAQ,CAAC,QAAQ,CAAC,KAAK,EAAE,CAAC,CAAC;IACrE,CAAC;AACL,CAAC,EAAE,EAAE,eAAe,EAAE,wCAA2B,EAAE,CAAC,CAAC;AACrD,oCAAuB,CAAC,WAAW,CAAC,CAAC,KAAoC,EAAQ,EAAE;IAC/E,IAAA,kBAAM,EAAC;QACH,MAAM,EAAE,oBAAoB;QAC5B,OAAO,EAAE,IAAI,CAAC,SAAS,CAAC,KAAK,CAAC;KACjC,CAAC,CAAC;AACP,CAAC,CAAC,CAAC;AACH,mCAAsB,CAAC,WAAW,CAAC,CAAC,KAAmC,EAAQ,EAAE;IAC7E,IAAA,kBAAM,EAAC;QACH,MAAM,EAAE,mBAAmB;QAC3B,OAAO,EAAE,IAAI,CAAC,SAAS,CAAC,KAAK,CAAC;KACjC,CAAC,CAAC;AACP,CAAC,CAAC,CAAC;AACH,wCAA2B,CAAC,WAAW,CAAC,CAAC,KAAc,EAAQ,EAAE;IAC7D,IAAA,kBAAM,EAAC;QACH,MAAM,EAAE,eAAe;QACvB,OAAO,EAAE,IAAI,CAAC,SAAS,CAAC,KAAK,CAAC;KACjC,CAAC,CAAC;AACP,CAAC,CAAC,CAAC","sourcesContent":["import { TypeormCdcEventsStream } from './sources/externalTopics';\nimport { CustomerDimensionStream, ProductDimensionStream, OrderDimensionStream, OrderItemStream, UnknownEventDeadLetterTopic, } from './sinkTopics';\nimport { CustomerDimension, ProductDimension, OrderDimension, OrderItemFact, RedpandaPgCdcPayload, CdcFields, } from './models';\nimport { cliLog, UInt64 } from '@514labs/moose-lib';\nfunction transformCdcPayload<T>(event: RedpandaPgCdcPayload<T>): T & CdcFields {\n    cliLog({\n        action: 'CDC Transform',\n        message: JSON.stringify(event),\n    });\n    cliLog({\n        action: 'Payload',\n        message: JSON.stringify(event.payload),\n    });\n    const lsn = parseInt(event.metadata.lsn, 16);\n    if (event.metadata.operation === 'delete') {\n        return {\n            ...event.payload,\n            is_deleted: 1,\n            lsn: lsn,\n        } as T & CdcFields;\n    }\n    return {\n        ...event.payload,\n        is_deleted: 0,\n        lsn: lsn,\n    } as T & CdcFields;\n}\nTypeormCdcEventsStream.addConsumer((event: unknown): void => {\n    const cdcEvent = event as RedpandaPgCdcPayload<ProductDimension | OrderDimension | OrderItemFact | CustomerDimension>;\n    let processedPayload;\n    switch (cdcEvent.metadata.table) {\n        case 'products':\n            processedPayload = transformCdcPayload<ProductDimension>(cdcEvent as RedpandaPgCdcPayload<ProductDimension>);\n            ProductDimensionStream.send(processedPayload);\n            break;\n        case 'customers':\n            processedPayload = transformCdcPayload<CustomerDimension>(cdcEvent as RedpandaPgCdcPayload<CustomerDimension>);\n            CustomerDimensionStream.send(processedPayload);\n            break;\n        case 'orders':\n            processedPayload = transformCdcPayload<OrderDimension>(cdcEvent as RedpandaPgCdcPayload<OrderDimension>);\n            OrderDimensionStream.send(processedPayload);\n            break;\n        case 'order_items':\n            processedPayload = transformCdcPayload<OrderItemFact>(cdcEvent as RedpandaPgCdcPayload<OrderItemFact>);\n            OrderItemStream.send(processedPayload);\n            break;\n        default:\n            throw new Error(`Unknown table: ${cdcEvent.metadata.table}`);\n    }\n}, { deadLetterQueue: UnknownEventDeadLetterTopic });\nCustomerDimensionStream.addConsumer((event: CustomerDimension & CdcFields): void => {\n    cliLog({\n        action: 'Customer Dimension',\n        message: JSON.stringify(event),\n    });\n});\nProductDimensionStream.addConsumer((event: ProductDimension & CdcFields): void => {\n    cliLog({\n        action: 'Product Dimension',\n        message: JSON.stringify(event),\n    });\n});\nUnknownEventDeadLetterTopic.addConsumer((event: unknown): void => {\n    cliLog({\n        action: 'Unknown Event',\n        message: JSON.stringify(event),\n    });\n});\n"]}