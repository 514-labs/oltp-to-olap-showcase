{"version":3,"file":"dictionaryBuilder.js","sourceRoot":"","sources":["../../moose/dictionaryBuilder.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Dictionary SDK\n *\n * ClickHouse dictionary factory function that creates SqlResource objects.\n * Handles connection configuration, SQL generation, and teardown automatically.\n *\n * Example:\n * ```ts\n * export const dictCustomers = Dictionary('dict_customers', {\n *   fields: {\n *     id: 'UInt64',\n *     country: 'String',\n *     city: 'String',\n *   },\n *   source: {\n *     table: 'dim_customer',\n *     where: 'is_deleted = 0',\n *   },\n * });\n * ```\n */\nimport { SqlResource } from '@514labs/moose-lib';\n// ============================================================================\n// TYPE DEFINITIONS\n// ============================================================================\nexport type ClickHouseType = 'UInt8' | 'UInt16' | 'UInt32' | 'UInt64' | 'Int8' | 'Int16' | 'Int32' | 'Int64' | 'Float32' | 'Float64' | 'String' | 'DateTime' | 'Date' | 'Bool' | string; // Allow custom types\nexport type DictionaryLayout = 'FLAT' | 'HASHED' | 'CACHE' | 'COMPLEX_KEY_HASHED' | 'COMPLEX_KEY_CACHE';\nexport interface DictionaryFields {\n    [fieldName: string]: ClickHouseType;\n}\nexport interface ClickHouseConnection {\n    host?: string;\n    port?: number;\n    user?: string;\n    password?: string;\n    database?: string;\n}\nexport interface DictionaryLifetime {\n    min: number;\n    max: number;\n}\n/**\n * Source configuration for dictionary data\n */\nexport interface DictionarySource {\n    /** Table name to source from */\n    table: string;\n    /** Database name (defaults to 'local') */\n    database?: string;\n    /** Specific columns to select (defaults to all fields) */\n    columns?: string[];\n    /** WHERE clause filter */\n    where?: string;\n}\n/**\n * Configuration for Dictionary\n */\nexport interface DictionaryConfig<T extends DictionaryFields = DictionaryFields> {\n    /** Field definitions with ClickHouse types */\n    fields: T;\n    /** Source configuration (table-based) */\n    source?: DictionarySource;\n    /** Custom SQL query (alternative to source) */\n    query?: string;\n    /** Primary key field(s) - defaults to 'id' or first field */\n    primaryKey?: keyof T | (keyof T)[];\n    /** Dictionary layout - defaults to 'FLAT' */\n    layout?: DictionaryLayout;\n    /** Cache lifetime in seconds - defaults to {min: 300, max: 600} */\n    lifetime?: Partial<DictionaryLifetime>;\n    /** Connection settings - uses defaults if not specified */\n    connection?: Partial<ClickHouseConnection>;\n    /** Database for dictionary creation */\n    database?: string;\n}\n// ============================================================================\n// DICTIONARY FACTORY FUNCTION\n// ============================================================================\n/**\n * Create a ClickHouse Dictionary as a SqlResource\n * Follows Moose SDK pattern with a factory function\n *\n * @example\n * export const dictCustomers = Dictionary('dict_customers', {\n *   fields: { id: 'UInt64', country: 'String', city: 'String' },\n *   source: { table: 'dim_customer', where: 'is_deleted = 0' },\n * });\n */\nexport function Dictionary<T extends DictionaryFields = DictionaryFields>(name: string, config: DictionaryConfig<T>): SqlResource {\n    const { createSql, teardownSql } = generateDictionarySql(name, config);\n    return new SqlResource(name, [createSql], [teardownSql]);\n}\n/**\n * Generate CREATE and DROP SQL statements for a dictionary\n */\nfunction generateDictionarySql<T extends DictionaryFields>(name: string, config: DictionaryConfig<T>): {\n    createSql: string;\n    teardownSql: string;\n} {\n    // Validate configuration\n    if (!config.source && !config.query) {\n        throw new Error(`Dictionary ${name}: Must specify either 'source' (table-based) or 'query' (custom SQL).`);\n    }\n    // Set defaults\n    const defaultConnection: ClickHouseConnection = {\n        host: 'localhost',\n        port: 9000,\n        user: 'panda',\n        password: 'pandapass',\n        database: 'local',\n    };\n    const connection = { ...defaultConnection, ...config.connection };\n    const layout = config.layout || 'FLAT';\n    const lifetime = { min: 300, max: 600, ...config.lifetime };\n    // Determine primary key(s)\n    let primaryKeys: (keyof T)[];\n    if (config.primaryKey) {\n        primaryKeys = Array.isArray(config.primaryKey) ? config.primaryKey : [config.primaryKey];\n    }\n    else if ('id' in config.fields) {\n        primaryKeys = ['id' as keyof T];\n    }\n    else {\n        primaryKeys = [Object.keys(config.fields)[0] as keyof T];\n    }\n    // Build source query\n    let sourceQuery: string;\n    if (config.query) {\n        sourceQuery = config.query;\n    }\n    else if (config.source) {\n        const sourceDb = config.source.database || connection.database || 'local';\n        const columns = config.source.columns || Object.keys(config.fields);\n        const columnList = columns.join(', ');\n        const whereClause = config.source.where ? ` WHERE ${config.source.where}` : '';\n        sourceQuery = `SELECT ${columnList} FROM ${sourceDb}.${config.source.table}${whereClause}`;\n    }\n    else {\n        throw new Error(`Dictionary ${name}: Invalid configuration.`);\n    }\n    // Build full dictionary name\n    const dictionaryName = config.database ? `${config.database}.${name}` : name;\n    // Build CREATE SQL\n    const fieldDefs = Object.entries(config.fields)\n        .map(([fieldName, fieldType]) => `    ${fieldName} ${fieldType}`)\n        .join(',\\n');\n    const pkList = primaryKeys.join(', ');\n    const sourceConfig = buildDictionarySourceConfig(connection);\n    const layoutFragment = layout === 'FLAT' ? 'FLAT()' : `${layout}()`;\n    const lifetimeFragment = `MIN ${lifetime.min} MAX ${lifetime.max}`;\n    const createSql = `\nCREATE DICTIONARY IF NOT EXISTS ${dictionaryName} (\n${fieldDefs}\n)\nPRIMARY KEY ${pkList}\nSOURCE(CLICKHOUSE(\n${sourceConfig}\n    QUERY '${sourceQuery}'\n))\nLAYOUT(${layoutFragment})\nLIFETIME(${lifetimeFragment});\n`.trim();\n    // Build DROP SQL\n    const teardownSql = `DROP DICTIONARY IF EXISTS ${dictionaryName};`;\n    return { createSql, teardownSql };\n}\n/**\n * Build ClickHouse connection configuration string\n */\nfunction buildDictionarySourceConfig(connection: ClickHouseConnection): string {\n    const parts: string[] = [];\n    if (connection.host) {\n        parts.push(`    HOST '${connection.host}'`);\n    }\n    if (connection.port) {\n        parts.push(`    PORT ${connection.port}`);\n    }\n    if (connection.user) {\n        parts.push(`    USER '${connection.user}'`);\n    }\n    if (connection.password) {\n        parts.push(`    PASSWORD '${connection.password}'`);\n    }\n    if (connection.database) {\n        parts.push(`    DB '${connection.database}'`);\n    }\n    return parts.join('\\n');\n}\n"]}