{"version":3,"file":"materializedViews.js","sourceRoot":"","sources":["../../moose/materializedViews.ts"],"names":[],"mappings":"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","sourcesContent":["import ____moose____typia from \"typia\";\n/**\n * ClickHouse Dictionaries for Fact Table Enrichment\n *\n * Dictionaries provide fast in-memory lookups to enrich fact tables with dimension data.\n * Used to denormalize OrderFact with customer, product, and order attributes.\n *\n * Configuration:\n * - LAYOUT(FLAT): Optimized for small-medium dimensions (<1M rows)\n * - LIFETIME: Cache refresh interval (5-10 minutes)\n * - SOURCE: Pulls data from dimension tables in ClickHouse\n */\nimport { OlapTable, ClickHouseEngines, MaterializedView, sql } from '@514labs/moose-lib';\nimport { OrderFact, CdcFields, OrderDimension, OrderItemFact } from './models';\nimport { Dictionary } from './dictionaryBuilder';\nimport { OrderDimensionTable, OrderItemTable } from './sinkTables';\n// ============================================================================\n// CUSTOMER DICTIONARY\n// ============================================================================\n// Provides customer attributes (country, city) for fact table enrichment\nexport const dictCustomers = Dictionary('dict_customers', {\n    fields: {\n        id: 'UInt64',\n        country: 'String',\n        city: 'String',\n    },\n    source: {\n        table: 'dim_customer',\n        where: 'is_deleted = 0',\n    },\n});\n// ============================================================================\n// PRODUCT DICTIONARY\n// ============================================================================\n// Provides product attributes (category, name) for fact table enrichment\nexport const dictProducts = Dictionary('dict_products', {\n    fields: {\n        id: 'UInt64',\n        category: 'String',\n        name: 'String',\n    },\n    source: {\n        table: 'dim_product',\n        where: 'is_deleted = 0',\n    },\n});\n// ============================================================================\n// ORDER DICTIONARY\n// ============================================================================\n// Provides order attributes (customerId, orderDate, status) for fact table enrichment\nexport const dictOrders = Dictionary('dict_orders', {\n    fields: {\n        id: 'UInt64',\n        customerId: 'UInt64',\n        orderDate: 'DateTime',\n        status: 'String',\n    },\n    source: {\n        table: 'dim_order',\n        where: 'is_deleted = 0',\n    },\n});\nexport const JoinedOrders = new OlapTable<OrderFact & CdcFields>('joined_orders', {\n    engine: ClickHouseEngines.ReplacingMergeTree,\n    orderByFields: ['id'],\n    ver: 'lsn',\n    isDeleted: 'is_deleted',\n}, ____moose____typia.json.schemas<[\n    import(\"@514labs/moose-lib\").StripDateIntersection<OrderFact & CdcFields>\n]>(), JSON.parse(\"[{\\\"name\\\":\\\"id\\\",\\\"data_type\\\":\\\"UInt64\\\",\\\"primary_key\\\":false,\\\"required\\\":true,\\\"unique\\\":false,\\\"default\\\":null,\\\"ttl\\\":null,\\\"annotations\\\":[]},{\\\"name\\\":\\\"customerId\\\",\\\"data_type\\\":\\\"UInt64\\\",\\\"primary_key\\\":false,\\\"required\\\":true,\\\"unique\\\":false,\\\"default\\\":null,\\\"ttl\\\":null,\\\"annotations\\\":[]},{\\\"name\\\":\\\"productId\\\",\\\"data_type\\\":\\\"UInt64\\\",\\\"primary_key\\\":false,\\\"required\\\":true,\\\"unique\\\":false,\\\"default\\\":null,\\\"ttl\\\":null,\\\"annotations\\\":[]},{\\\"name\\\":\\\"orderId\\\",\\\"data_type\\\":\\\"UInt64\\\",\\\"primary_key\\\":false,\\\"required\\\":true,\\\"unique\\\":false,\\\"default\\\":null,\\\"ttl\\\":null,\\\"annotations\\\":[]},{\\\"name\\\":\\\"orderDate\\\",\\\"data_type\\\":\\\"DateTime\\\",\\\"primary_key\\\":false,\\\"required\\\":true,\\\"unique\\\":false,\\\"default\\\":null,\\\"ttl\\\":null,\\\"annotations\\\":[]},{\\\"name\\\":\\\"quantity\\\",\\\"data_type\\\":\\\"Float\\\",\\\"primary_key\\\":false,\\\"required\\\":true,\\\"unique\\\":false,\\\"default\\\":null,\\\"ttl\\\":null,\\\"annotations\\\":[]},{\\\"name\\\":\\\"unitPrice\\\",\\\"data_type\\\":\\\"Float\\\",\\\"primary_key\\\":false,\\\"required\\\":true,\\\"unique\\\":false,\\\"default\\\":null,\\\"ttl\\\":null,\\\"annotations\\\":[]},{\\\"name\\\":\\\"revenue\\\",\\\"data_type\\\":\\\"Float\\\",\\\"primary_key\\\":false,\\\"required\\\":true,\\\"unique\\\":false,\\\"default\\\":null,\\\"ttl\\\":null,\\\"annotations\\\":[]},{\\\"name\\\":\\\"orderStatus\\\",\\\"data_type\\\":\\\"String\\\",\\\"primary_key\\\":false,\\\"required\\\":true,\\\"unique\\\":false,\\\"default\\\":null,\\\"ttl\\\":null,\\\"annotations\\\":[]},{\\\"name\\\":\\\"customerCountry\\\",\\\"data_type\\\":\\\"String\\\",\\\"primary_key\\\":false,\\\"required\\\":true,\\\"unique\\\":false,\\\"default\\\":null,\\\"ttl\\\":null,\\\"annotations\\\":[]},{\\\"name\\\":\\\"customerCity\\\",\\\"data_type\\\":\\\"String\\\",\\\"primary_key\\\":false,\\\"required\\\":true,\\\"unique\\\":false,\\\"default\\\":null,\\\"ttl\\\":null,\\\"annotations\\\":[]},{\\\"name\\\":\\\"productCategory\\\",\\\"data_type\\\":\\\"String\\\",\\\"primary_key\\\":false,\\\"required\\\":true,\\\"unique\\\":false,\\\"default\\\":null,\\\"ttl\\\":null,\\\"annotations\\\":[]},{\\\"name\\\":\\\"productName\\\",\\\"data_type\\\":\\\"String\\\",\\\"primary_key\\\":false,\\\"required\\\":true,\\\"unique\\\":false,\\\"default\\\":null,\\\"ttl\\\":null,\\\"annotations\\\":[]},{\\\"name\\\":\\\"is_deleted\\\",\\\"data_type\\\":\\\"UInt8\\\",\\\"primary_key\\\":false,\\\"required\\\":true,\\\"unique\\\":false,\\\"default\\\":null,\\\"ttl\\\":null,\\\"annotations\\\":[]},{\\\"name\\\":\\\"lsn\\\",\\\"data_type\\\":\\\"UInt64\\\",\\\"primary_key\\\":false,\\\"required\\\":true,\\\"unique\\\":false,\\\"default\\\":null,\\\"ttl\\\":null,\\\"annotations\\\":[]}]\") as any, {\n    validate: (data: unknown) => {\n        const result = ____moose____typia.createValidate<import(\"@514labs/moose-lib\").StripDateIntersection<OrderFact & CdcFields>>()(data);\n        return {\n            success: result.success,\n            data: result.success ? result.data : undefined,\n            errors: result.success ? undefined : result.errors\n        };\n    },\n    assert: ____moose____typia.createAssert<import(\"@514labs/moose-lib\").StripDateIntersection<OrderFact & CdcFields>>(),\n    is: ____moose____typia.createIs<import(\"@514labs/moose-lib\").StripDateIntersection<OrderFact & CdcFields>>()\n});\nexport const OrderFactEnrichedView = new MaterializedView<OrderFact & CdcFields>({\n    materializedViewName: 'join_orders_mv',\n    selectStatement: sql `\n    SELECT\n    ${OrderItemTable.columns.id} as id,\n    ${OrderItemTable.columns.orderId} as orderId,\n    ${OrderItemTable.columns.productId} as productId,\n    ${OrderItemTable.columns.quantity} as quantity,\n    ${OrderItemTable.columns.price} as unitPrice,\n    ${OrderItemTable.columns.quantity} * ${OrderItemTable.columns.price} as revenue,\n\n    -- Lookup from dictionaries\n    dictGet('dict_orders', 'customerId', oi.orderId) as customerId,\n    dictGet('dict_orders', 'orderDate', oi.orderId) as orderDate,\n    dictGet('dict_orders', 'status', oi.orderId) as orderStatus,\n\n    dictGet('dict_customers', 'country',\n        dictGet('dict_orders', 'customerId', oi.orderId)\n    ) as customerCountry,\n\n    dictGet('dict_customers', 'city',\n        dictGet('dict_orders', 'customerId', oi.orderId)\n    ) as customerCity,\n\n    dictGet('dict_products', 'category', oi.productId) as productCategory,\n    dictGet('dict_products', 'name', oi.productId) as productName,\n\n    ${OrderItemTable.columns.is_deleted},\n    ${OrderItemTable.columns.lsn}\n    FROM ${OrderItemTable} oi\n    `,\n    selectTables: [OrderItemTable, dictCustomers, dictProducts, dictOrders],\n    targetTable: JoinedOrders,\n}, ____moose____typia.json.schemas<[\n    import(\"@514labs/moose-lib\").StripDateIntersection<OrderFact & CdcFields>\n]>(), JSON.parse(\"[{\\\"name\\\":\\\"id\\\",\\\"data_type\\\":\\\"UInt64\\\",\\\"primary_key\\\":false,\\\"required\\\":true,\\\"unique\\\":false,\\\"default\\\":null,\\\"ttl\\\":null,\\\"annotations\\\":[]},{\\\"name\\\":\\\"customerId\\\",\\\"data_type\\\":\\\"UInt64\\\",\\\"primary_key\\\":false,\\\"required\\\":true,\\\"unique\\\":false,\\\"default\\\":null,\\\"ttl\\\":null,\\\"annotations\\\":[]},{\\\"name\\\":\\\"productId\\\",\\\"data_type\\\":\\\"UInt64\\\",\\\"primary_key\\\":false,\\\"required\\\":true,\\\"unique\\\":false,\\\"default\\\":null,\\\"ttl\\\":null,\\\"annotations\\\":[]},{\\\"name\\\":\\\"orderId\\\",\\\"data_type\\\":\\\"UInt64\\\",\\\"primary_key\\\":false,\\\"required\\\":true,\\\"unique\\\":false,\\\"default\\\":null,\\\"ttl\\\":null,\\\"annotations\\\":[]},{\\\"name\\\":\\\"orderDate\\\",\\\"data_type\\\":\\\"DateTime\\\",\\\"primary_key\\\":false,\\\"required\\\":true,\\\"unique\\\":false,\\\"default\\\":null,\\\"ttl\\\":null,\\\"annotations\\\":[]},{\\\"name\\\":\\\"quantity\\\",\\\"data_type\\\":\\\"Float\\\",\\\"primary_key\\\":false,\\\"required\\\":true,\\\"unique\\\":false,\\\"default\\\":null,\\\"ttl\\\":null,\\\"annotations\\\":[]},{\\\"name\\\":\\\"unitPrice\\\",\\\"data_type\\\":\\\"Float\\\",\\\"primary_key\\\":false,\\\"required\\\":true,\\\"unique\\\":false,\\\"default\\\":null,\\\"ttl\\\":null,\\\"annotations\\\":[]},{\\\"name\\\":\\\"revenue\\\",\\\"data_type\\\":\\\"Float\\\",\\\"primary_key\\\":false,\\\"required\\\":true,\\\"unique\\\":false,\\\"default\\\":null,\\\"ttl\\\":null,\\\"annotations\\\":[]},{\\\"name\\\":\\\"orderStatus\\\",\\\"data_type\\\":\\\"String\\\",\\\"primary_key\\\":false,\\\"required\\\":true,\\\"unique\\\":false,\\\"default\\\":null,\\\"ttl\\\":null,\\\"annotations\\\":[]},{\\\"name\\\":\\\"customerCountry\\\",\\\"data_type\\\":\\\"String\\\",\\\"primary_key\\\":false,\\\"required\\\":true,\\\"unique\\\":false,\\\"default\\\":null,\\\"ttl\\\":null,\\\"annotations\\\":[]},{\\\"name\\\":\\\"customerCity\\\",\\\"data_type\\\":\\\"String\\\",\\\"primary_key\\\":false,\\\"required\\\":true,\\\"unique\\\":false,\\\"default\\\":null,\\\"ttl\\\":null,\\\"annotations\\\":[]},{\\\"name\\\":\\\"productCategory\\\",\\\"data_type\\\":\\\"String\\\",\\\"primary_key\\\":false,\\\"required\\\":true,\\\"unique\\\":false,\\\"default\\\":null,\\\"ttl\\\":null,\\\"annotations\\\":[]},{\\\"name\\\":\\\"productName\\\",\\\"data_type\\\":\\\"String\\\",\\\"primary_key\\\":false,\\\"required\\\":true,\\\"unique\\\":false,\\\"default\\\":null,\\\"ttl\\\":null,\\\"annotations\\\":[]},{\\\"name\\\":\\\"is_deleted\\\",\\\"data_type\\\":\\\"UInt8\\\",\\\"primary_key\\\":false,\\\"required\\\":true,\\\"unique\\\":false,\\\"default\\\":null,\\\"ttl\\\":null,\\\"annotations\\\":[]},{\\\"name\\\":\\\"lsn\\\",\\\"data_type\\\":\\\"UInt64\\\",\\\"primary_key\\\":false,\\\"required\\\":true,\\\"unique\\\":false,\\\"default\\\":null,\\\"ttl\\\":null,\\\"annotations\\\":[]}]\") as any);\n"]}