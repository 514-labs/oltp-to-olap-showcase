# Moose CDC Extension - Docker Compose Override
# This version relies on shared CDC templates from packages/shared/cdc.

services:
  cdc-setup:
    image: postgres:15-alpine
    container_name: ${CDC_SETUP_CONTAINER_NAME:-typeorm-cdc-setup}
    environment:
      PGHOST: ${OLTP_POSTGRES_CONTAINER:-typeorm-oltp-postgres}
      PGPORT: 5432
      PGUSER: ${POSTGRES_USER:-postgres}
      PGPASSWORD: ${POSTGRES_PASSWORD:-postgres}
      PGDATABASE: ${OLTP_POSTGRES_DB:-typeorm_db}
      POSTGRES_CDC_PUBLICATION: ${POSTGRES_CDC_PUBLICATION:-redpanda_cdc_publication}
      POSTGRES_CDC_SLOT: ${POSTGRES_CDC_SLOT:-redpanda_cdc_slot}
      POSTGRES_CDC_SCHEMA: ${POSTGRES_CDC_SCHEMA:-public}
      POSTGRES_CDC_TABLES: ${POSTGRES_CDC_TABLES:-customers,products,orders,order_items}
      POSTGRES_CDC_WAIT_FOR_TABLE: ${POSTGRES_CDC_WAIT_FOR_TABLE:-customers}
    volumes:
      - ${PWD}/../../packages/shared/cdc/init-postgres-cdc.sh:/init-postgres-cdc.sh:ro
    command: ["/bin/sh", "/init-postgres-cdc.sh"]
    restart: "no"
    networks:
      - oltp-network

  redpanda-connect:
    image: docker.redpanda.com/redpandadata/connect:latest
    container_name: ${CDC_CONNECT_CONTAINER_NAME:-typeorm-redpanda-connect}
    depends_on:
      cdc-setup:
        condition: service_completed_successfully
    volumes:
      - ${PWD}/../../packages/shared/cdc/redpanda-connect.template.yaml:/connect.yaml:ro
    command: ["run", "/connect.yaml"]
    ports:
      - "${POSTGRES_CDC_HTTP_PORT:-4195}:4195"
    environment:
      REDPANDA_LICENSE: ${REDPANDA_LICENSE:-}
      LOG_LEVEL: ${CDC_LOG_LEVEL:-info}
      POSTGRES_CDC_DSN: ${POSTGRES_CDC_DSN:-postgres://postgres:postgres@typeorm-oltp-postgres:5432/typeorm_db?sslmode=disable}
      POSTGRES_CDC_SCHEMA: ${POSTGRES_CDC_SCHEMA:-public}
      POSTGRES_CDC_SLOT: ${POSTGRES_CDC_SLOT:-redpanda_cdc_slot}
      POSTGRES_CDC_PUBLICATION: ${POSTGRES_CDC_PUBLICATION:-redpanda_cdc_publication}
      POSTGRES_CDC_TABLES_JSON: '${POSTGRES_CDC_TABLES_JSON:-["customers","products","orders","order_items"]}'
      POSTGRES_CDC_TOPIC: ${POSTGRES_CDC_TOPIC:-typeorm_cdc_events}
      POSTGRES_CDC_BROKER_ADDRESS: ${POSTGRES_CDC_BROKER_ADDRESS:-redpanda:9092}
      POSTGRES_CDC_HTTP_ADDR: ${POSTGRES_CDC_HTTP_ADDR:-0.0.0.0:4195}
    networks:
      - oltp-network
      - default

networks:
  oltp-network:
    external: true
    name: ${OLTP_POSTGRES_NETWORK:-oltp-network}
