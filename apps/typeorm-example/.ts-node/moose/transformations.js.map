{"version":3,"file":"transformations.js","sourceRoot":"","sources":["../../moose/transformations.ts"],"names":[],"mappings":"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","sourcesContent":["import { TypeormCdcEventsStream } from './sources/externalTopics';\nimport { CustomerDimensionStream, ProductDimensionStream, OrderDimensionStream, OrderItemStream, UnknownEventDeadLetterTopic, } from './sinkTopics';\nimport { CustomerDimension, ProductDimension, OrderDimension, OrderItemFact, RedpandaPgCdcPayload, CdcFields, } from './models';\nimport { cliLog, UInt64 } from '@514labs/moose-lib';\nfunction transformCdcPayload<T>(event: RedpandaPgCdcPayload<T>): T & CdcFields {\n    cliLog({\n        action: 'CDC Transform',\n        message: JSON.stringify(event),\n    });\n    // Extract payload by destructuring (removes _metadata)\n    const { _metadata, ...payload } = event;\n    cliLog({\n        action: 'Payload',\n        message: JSON.stringify(payload),\n    });\n    const lsn = parseInt(_metadata.lsn, 16);\n    if (_metadata.operation === 'delete') {\n        return {\n            ...payload,\n            is_deleted: 1,\n            lsn: lsn,\n        } as T & CdcFields;\n    }\n    return {\n        ...payload,\n        is_deleted: 0,\n        lsn: lsn,\n    } as T & CdcFields;\n}\nTypeormCdcEventsStream.addConsumer((event: unknown): void => {\n    const cdcEvent = event as RedpandaPgCdcPayload<ProductDimension | OrderDimension | OrderItemFact | CustomerDimension>;\n    let processedPayload;\n    switch (cdcEvent._metadata.table) {\n        case 'products':\n            processedPayload = transformCdcPayload<ProductDimension>(cdcEvent as RedpandaPgCdcPayload<ProductDimension>);\n            ProductDimensionStream.send(processedPayload);\n            break;\n        case 'customers':\n            processedPayload = transformCdcPayload<CustomerDimension>(cdcEvent as RedpandaPgCdcPayload<CustomerDimension>);\n            CustomerDimensionStream.send(processedPayload);\n            break;\n        case 'orders':\n            processedPayload = transformCdcPayload<OrderDimension>(cdcEvent as RedpandaPgCdcPayload<OrderDimension>);\n            OrderDimensionStream.send(processedPayload);\n            break;\n        case 'order_items':\n            processedPayload = transformCdcPayload<OrderItemFact>(cdcEvent as RedpandaPgCdcPayload<OrderItemFact>);\n            OrderItemStream.send(processedPayload);\n            break;\n        default:\n            throw new Error(`Unknown table: ${cdcEvent._metadata.table}`);\n    }\n}, { deadLetterQueue: UnknownEventDeadLetterTopic });\nCustomerDimensionStream.addConsumer((event: CustomerDimension & CdcFields): void => {\n    cliLog({\n        action: 'Customer Dimension',\n        message: JSON.stringify(event),\n    });\n});\nProductDimensionStream.addConsumer((event: ProductDimension & CdcFields): void => {\n    cliLog({\n        action: 'Product Dimension',\n        message: JSON.stringify(event),\n    });\n});\nUnknownEventDeadLetterTopic.addConsumer((event: unknown): void => {\n    cliLog({\n        action: 'Unknown Event',\n        message: JSON.stringify(event),\n    });\n});\nconst orderItem = { id: 3, orderId: 1, price: 777.88, productId: 1, quantity: 1 };\nconst order = {\n    customerId: 7,\n    id: 1,\n    orderDate: '2025-10-21T19:33:53.571Z',\n    status: 'cancelled',\n    total: 4254.39,\n};\n"]}