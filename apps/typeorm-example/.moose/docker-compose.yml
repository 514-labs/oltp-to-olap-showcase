volumes:
  redpanda-0: null
  clickhouse-0-data: null
  clickhouse-0-logs: null
  clickhouse-0-users: null
  clickhouse-keeper-data: null
  clickhouse-keeper-lib: null
  redis-data:


services:
  redis:
    image: redis:latest
    ports:
      - "${REDIS_PORT:-6379}:6379"
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - redis-data:/data
  redpanda:
    image: docker.redpanda.com/redpandadata/redpanda:v24.3.11
    ports:
      # Internal listener stays internal to the docker network; no host binding to avoid conflicts
      # External listener is parameterized to allow multiple projects concurrently
      - "19092:19092"
    volumes:
      - redpanda-0:/var/lib/redpanda/data
    command:
      - redpanda
      - start
      - --kafka-addr=internal://0.0.0.0:9092,external://0.0.0.0:19092
      - --advertise-kafka-addr=internal://redpanda:9092,external://localhost:19092
      - --pandaproxy-addr=internal://0.0.0.0:8082,external://0.0.0.0:18082
      - --advertise-pandaproxy-addr=internal://redpanda:8082,external://localhost:18082
      - --mode=dev-container
      - --smp=1
      - --memory=2G
      - --node-id=0
    healthcheck:
      test:
        ["CMD-SHELL", "rpk cluster health | grep -E 'Healthy:.+true' || exit 1"]
      interval: 15s
      timeout: 3s
      retries: 5
      start_period: 5s
  clickhouse-keeper:
    image: docker.io/clickhouse/clickhouse-keeper:${CLICKHOUSE_VERSION:-25.6}
    volumes:
      - clickhouse-keeper-data:/var/lib/clickhouse-keeper
      - clickhouse-keeper-lib:/var/lib/clickhouse
    environment:
      - KEEPER_SERVER_ID=1
    expose:
      - "9181"
    networks:
      - clickhouse-network
    healthcheck:
      test: ["CMD-SHELL", "echo 'ruok' | nc clickhouse-keeper 9181 | grep -q 'imok'"]
      interval: 10s
      retries: 5
      start_period: 20s
      timeout: 5s
    command:
      - sh
      - -c
      - |
        mkdir -p /etc/clickhouse-keeper
        cat > /etc/clickhouse-keeper/keeper_config.xml << 'EOF'
        <clickhouse>
          <logger>
            <level>information</level>
            <log>/var/log/clickhouse-keeper/clickhouse-keeper.log</log>
            <errorlog>/var/log/clickhouse-keeper/clickhouse-keeper.err.log</errorlog>
            <size>1000M</size>
            <count>10</count>
          </logger>
          <listen_host>0.0.0.0</listen_host>
          <max_connections>4096</max_connections>
          <keeper_server>
            <tcp_port>9181</tcp_port>
            <server_id>1</server_id>
            <log_storage_path>/var/lib/clickhouse-keeper/coordination/log</log_storage_path>
            <snapshot_storage_path>/var/lib/clickhouse-keeper/coordination/snapshots</snapshot_storage_path>
            <coordination_settings>
              <operation_timeout_ms>10000</operation_timeout_ms>
              <min_session_timeout_ms>10000</min_session_timeout_ms>
              <session_timeout_ms>30000</session_timeout_ms>
              <raft_logs_level>information</raft_logs_level>
            </coordination_settings>
            <hostname_checks_enabled>false</hostname_checks_enabled>
            <raft_configuration>
              <server>
                <id>1</id>
                <hostname>clickhouse-keeper</hostname>
                <port>9234</port>
              </server>
            </raft_configuration>
            <four_letter_word_white_list>*</four_letter_word_white_list>
          </keeper_server>
        </clickhouse>
        EOF
        exec /entrypoint.sh

  clickhousedb:
    image: docker.io/clickhouse/clickhouse-server:${CLICKHOUSE_VERSION:-25.6}
    depends_on:
      clickhouse-keeper:
        condition: service_healthy
    volumes:
      - clickhouse-0-data:/var/lib/clickhouse/
      - clickhouse-0-logs:/var/log/clickhouse-server/
      - clickhouse-0-users:/etc/clickhouse-server/users.d
    environment:
      - CLICKHOUSE_DB=${DB_NAME:-local}
      - CLICKHOUSE_USER=${CLICKHOUSE_USER:-panda}
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD:-pandapass}
      - CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT=1
    ports:
      - "${CLICKHOUSE_HOST_PORT:-18123}:8123"
      - "9000:9000"
    networks:
      - clickhouse-network
    healthcheck:
      test: ["CMD-SHELL", "clickhouse-client -q 'select version()'"]
      interval: 5s
      retries: 2
      start_period: 20s
      timeout: 20s
    ulimits:
      nofile:
        soft: 20000
        hard: 40000
    command:
      - sh
      - -c
      - |
        mkdir -p /etc/clickhouse-server/config.d
        cat > /etc/clickhouse-server/config.d/keeper.xml << 'EOF'
        <clickhouse>
          <zookeeper>
            <node>
              <host>clickhouse-keeper</host>
              <port>9181</port>
            </node>
          </zookeeper>
          <distributed_ddl>
            <path>/clickhouse/task_queue/ddl</path>
          </distributed_ddl>
          <keeper_map_path_prefix>/keeper_map_tables</keeper_map_path_prefix>
          <macros>
            <shard>01</shard>
            <replica>replica_1</replica>
            <database>local</database>
          </macros>
          <!-- Macros are used for ReplicatedMergeTree default paths -->
          <!-- Default path: /clickhouse/tables/{uuid}/{shard} works with Atomic database (default) -->
        </clickhouse>
        EOF
        exec /entrypoint.sh


networks:
  temporal-network:
  clickhouse-network:
