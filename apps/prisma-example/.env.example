# =============================================================================
# APPLICATION CONFIGURATION
# =============================================================================

# Node environment (development, production, test)
NODE_ENV=development

# API server port
PORT=3000

# =============================================================================
# POSTGRESQL CONFIGURATION (OLTP Database)
# =============================================================================

# Prisma database connection string
# Format: postgresql://USER:PASSWORD@HOST:PORT/DATABASE
DATABASE_URL="postgresql://postgres:postgres@localhost:5432/prisma_db"

# PostgreSQL connection details (used by docker-compose)
POSTGRES_USER=postgres
POSTGRES_PASSWORD=postgres
POSTGRES_DB=prisma_db
DB_HOST=localhost
DB_PORT=5432

# PostgreSQL container name (for Docker networks)
OLTP_POSTGRES_CONTAINER=prisma-postgres
OLTP_POSTGRES_NETWORK=prisma-network

# =============================================================================
# CDC (CHANGE DATA CAPTURE) CONFIGURATION
# =============================================================================

# --- PostgreSQL CDC Connection ---
# Full DSN for Redpanda Connect to read PostgreSQL WAL
# IMPORTANT: Must include ?sslmode=disable for CDC connector
POSTGRES_CDC_DSN=postgresql://postgres:postgres@prisma-postgres:5432/prisma_db?sslmode=disable

# PostgreSQL schema to monitor (default: public)
POSTGRES_CDC_SCHEMA=public

# --- CDC Publication & Slot ---
# Logical replication publication name (created by init-postgres-cdc.sh)
POSTGRES_CDC_PUBLICATION=redpanda_cdc_publication

# Replication slot name (tracks CDC consumption position)
POSTGRES_CDC_SLOT=redpanda_cdc_slot

# --- Tables to Monitor ---
# Comma-separated list for init-postgres-cdc.sh (shell script)
# Prisma uses PascalCase: Customer, Product, Order, OrderItem
POSTGRES_CDC_TABLES=Customer,Product,Order,OrderItem

# JSON array for redpanda-connect.template.yaml (YAML template)
POSTGRES_CDC_TABLES_JSON=["Customer","Product","Order","OrderItem"]

# Table to wait for before starting CDC (ensures schema is ready)
POSTGRES_CDC_WAIT_FOR_TABLE=Customer

# --- Kafka/Redpanda Configuration ---
# Topic where CDC events are published
POSTGRES_CDC_TOPIC=prisma_cdc_events

# Redpanda broker address (Kafka-compatible)
POSTGRES_CDC_BROKER_ADDRESS=redpanda:9092

# --- CDC Container Configuration ---
# Container names (useful for multi-app setups)
CDC_SETUP_CONTAINER_NAME=prisma-cdc-setup
CDC_CONNECT_CONTAINER_NAME=prisma-redpanda-connect

# Redpanda Connect HTTP API address (health checks, metrics)
POSTGRES_CDC_HTTP_ADDR=0.0.0.0:4195

# Exposed port for Redpanda Connect HTTP API
POSTGRES_CDC_HTTP_PORT=4197

# Log level for CDC connector (debug, info, warn, error)
CDC_LOG_LEVEL=info

# =============================================================================
# REDPANDA CONFIGURATION
# =============================================================================

# Redpanda Enterprise license key (required for postgres_cdc connector)
# Get a trial license: https://redpanda.com/try-enterprise
REDPANDA_LICENSE=your_license_key_here

# =============================================================================
# MOOSE CONFIGURATION
# =============================================================================

# Moose development server port (default: 4000)
MOOSE_PORT=4000

# ClickHouse connection (used by Moose)
CLICKHOUSE_HOST=localhost
CLICKHOUSE_PORT=8123
CLICKHOUSE_USER=default
CLICKHOUSE_PASSWORD=
CLICKHOUSE_DB=local

# =============================================================================
# NOTES
# =============================================================================
#
# Table Naming Convention (Prisma):
# - Prisma models: PascalCase (Customer, Product, Order, OrderItem)
# - PostgreSQL tables: PascalCase by default (can be customized with @@map)
#
# Quick Start:
# 1. Copy this file: cp .env.example .env
# 2. Update values for your environment
# 3. Add your REDPANDA_LICENSE key
# 4. Run: docker-compose -f docker-compose.oltp.yaml -f docker-compose.dev.override.yaml up -d
# 5. Run: pnpm prisma:push (or prisma:migrate)
# 6. Run: pnpm dev
#
# Verification:
# - Check CDC setup: docker logs prisma-cdc-setup
# - Check connector: curl http://localhost:4197/ready
# - View publications: docker exec prisma-postgres psql -U postgres -d prisma_db \
#                      -c "SELECT * FROM pg_publication_tables;"
#
# For more info: see packages/shared/cdc/README.md
