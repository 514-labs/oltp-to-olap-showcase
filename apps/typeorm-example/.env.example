# =============================================================================
# APPLICATION CONFIGURATION
# =============================================================================

# Node environment (development, production, test)
NODE_ENV=development

# API server port
PORT=3000

# =============================================================================
# POSTGRESQL CONFIGURATION (OLTP Database)
# =============================================================================

# TypeORM database connection
# Note: TypeORM reads from individual env vars, not DATABASE_URL
DB_HOST=localhost
DB_PORT=5433
DB_USER=postgres
DB_PASSWORD=postgres
DB_NAME=typeorm_db

# PostgreSQL connection details (used by docker-compose)
POSTGRES_USER=postgres
POSTGRES_PASSWORD=postgres
POSTGRES_DB=typeorm_db

# PostgreSQL container name (for Docker networks)
OLTP_POSTGRES_CONTAINER=typeorm-oltp-postgres
OLTP_POSTGRES_NETWORK=oltp-network

# PostgreSQL WAL settings (for CDC)
POSTGRES_WAL_LEVEL=logical
POSTGRES_MAX_REPLICATION_SLOTS=10
POSTGRES_MAX_WAL_SENDERS=10

# =============================================================================
# CDC (CHANGE DATA CAPTURE) CONFIGURATION
# =============================================================================

# --- PostgreSQL CDC Connection ---
# Full DSN for Redpanda Connect to read PostgreSQL WAL
# IMPORTANT: Must include ?sslmode=disable for CDC connector
POSTGRES_CDC_DSN=postgres://postgres:postgres@typeorm-oltp-postgres:5432/typeorm_db?sslmode=disable

# PostgreSQL schema to monitor (default: public)
POSTGRES_CDC_SCHEMA=public

# --- CDC Publication & Slot ---
# Logical replication publication name (created by init-postgres-cdc.sh)
POSTGRES_CDC_PUBLICATION=redpanda_cdc_publication

# Replication slot name (tracks CDC consumption position)
POSTGRES_CDC_SLOT=redpanda_cdc_slot

# --- Tables to Monitor ---
# Comma-separated list for init-postgres-cdc.sh (shell script)
# TypeORM uses lowercase plural: customers, products, orders, order_items
POSTGRES_CDC_TABLES=customers,products,orders,order_items

# JSON array for redpanda-connect.template.yaml (YAML template)
POSTGRES_CDC_TABLES_JSON=["customers","products","orders","order_items"]

# Table to wait for before starting CDC (ensures schema is ready)
POSTGRES_CDC_WAIT_FOR_TABLE=customers

# --- Kafka/Redpanda Configuration ---
# Topic where CDC events are published
POSTGRES_CDC_TOPIC=typeorm_cdc_events

# Redpanda broker address (Kafka-compatible)
POSTGRES_CDC_BROKER_ADDRESS=redpanda:9092

# --- CDC Container Configuration ---
# Container names (useful for multi-app setups)
CDC_SETUP_CONTAINER_NAME=typeorm-cdc-setup
CDC_CONNECT_CONTAINER_NAME=typeorm-redpanda-connect

# Redpanda Connect HTTP API address (health checks, metrics)
POSTGRES_CDC_HTTP_ADDR=0.0.0.0:4195

# Exposed port for Redpanda Connect HTTP API
POSTGRES_CDC_HTTP_PORT=4195

# Log level for CDC connector (debug, info, warn, error)
CDC_LOG_LEVEL=info

# =============================================================================
# REDPANDA CONFIGURATION
# =============================================================================

# Redpanda Enterprise license key (required for postgres_cdc connector)
# Get a trial license: https://redpanda.com/try-enterprise
REDPANDA_LICENSE=your_license_key_here

# =============================================================================
# MOOSE CONFIGURATION
# =============================================================================

# Moose development server port (default: 4000)
MOOSE_PORT=4000

# ClickHouse connection (used by Moose)
CLICKHOUSE_HOST=localhost
CLICKHOUSE_PORT=8123
CLICKHOUSE_USER=default
CLICKHOUSE_PASSWORD=
CLICKHOUSE_DB=local

# =============================================================================
# NOTES
# =============================================================================
#
# Table Naming Convention (TypeORM):
# - TypeORM entities: PascalCase (Customer, Product, Order, OrderItem)
# - PostgreSQL tables: lowercase plural (customers, products, orders, order_items)
#
# Quick Start:
# 1. Copy this file: cp .env.example .env
# 2. Update values for your environment
# 3. Add your REDPANDA_LICENSE key
# 4. Run: docker-compose -f docker-compose.oltp.yaml -f docker-compose.dev.override.yaml up -d
# 5. Wait for CDC setup: docker logs typeorm-cdc-setup (should show "âœ… CDC publication ready!")
# 6. Run: pnpm install && pnpm dev
#
# Verification:
# - Check CDC setup: docker logs typeorm-cdc-setup
# - Check connector: curl http://localhost:4195/ready
# - View publications: docker exec typeorm-oltp-postgres psql -U postgres -d typeorm_db \
#                      -c "SELECT * FROM pg_publication_tables;"
# - API docs: http://localhost:3000/reference
#
# Troubleshooting:
# - If CDC setup is stuck "Waiting for tables", start the API first (pnpm dev)
# - Tables are created by TypeORM synchronize on first API startup
# - Check logs: docker logs typeorm-oltp-postgres
# - Reset: docker-compose down -v && docker volume prune -f
#
# For more info: see packages/shared/cdc/README.md
